import{d as e}from"./fbfb0d48.js";import{s as t,c as i}from"./0770b19d.js";import{c as s,_ as n,p as o,q as a,a as l,L as r,h as d}from"./f0da52c9.js";class c{constructor(e){this.parent=e,this.storyEl=null,this.conversationEl=null}openMenu(e){const t=document.createElement("ae-battle-menu");t.round=e.round,t.clicksDisabled=e.clicksDisabled,this.parent.append(t)}openNewTurnPopup(e){return new Promise((t=>{const i=document.createElement("ae-new-turn");i.round=e.round,i.playerName=e.playerName,i.playerColor=e.playerColor,i.income=e.income,i.addEventListener("new-turn-close",(()=>t())),this.parent.append(i),e.autoClose&&setTimeout((()=>i.close()),e.autoClose)}))}async openStory(e){this.storyEl||(this.storyEl=document.createElement("ae-story"),this.parent.append(this.storyEl)),this.storyEl.text=e.text,this.storyEl.illustration=e.illustration}closeStory(){var e;null===(e=this.storyEl)||void 0===e||e.remove(),this.storyEl=null}openConversation(e){this.conversationEl||(this.conversationEl=document.createElement("ae-conversation"),this.parent.append(this.conversationEl)),this.conversationEl.character=e.character,this.conversationEl.position=e.position,this.conversationEl.text=e.text}closeConversation(){var e;null===(e=this.conversationEl)||void 0===e||e.remove(),this.conversationEl=null}openNotification(e){return new Promise((t=>{const i=document.createElement("ae-notification");i.header=e.header,i.text=e.content,i.addEventListener("notification-close",(()=>t())),this.parent.append(i),e.autoClose&&setTimeout((()=>i.close()),e.autoClose)}))}openGameEnd(e){const t=document.createElement("ae-game-end");t.victory=e.victory,this.parent.append(t)}openSaveDialog(e){const t=document.createElement("ae-dialog");t.type="save";const i=document.createElement("ae-save-battle");i.name=e,i.addEventListener("save-submit",(()=>t.close())),i.addEventListener("save-cancel",(()=>t.close())),t.append(i),this.parent.append(t)}openUnitStore(e){const t=document.createElement("ae-big-dialog");t.closeable=!0;const i=document.createElement("ae-unit-store");i.units=e.units,i.selected=e.units[0],i.color=e.color,i.money=e.money,i.storeCell=e.storeCell,i.addEventListener("unit-store-buy",(()=>t.close())),t.append(i),this.parent.append(t)}openUnitInfo(e){const t=document.createElement("ae-big-dialog"),i=document.createElement("ae-unit-info");i.unit=e,t.append(i),this.parent.append(t)}}class p{constructor(e){this.el=e,this.eventService=window.eventService,this.api=window.apiService,this.soundService=window.soundService,this.ai=window.ai}init(){this.startServerEventsHandling(),this.api.init()}startServerEventsHandling(){const t=[];let i=!1;const s=this;async function n(){if(!i&&t.length){const o=t.shift();i=!0,await e(0),await s.handleModelChanges(o),i=!1,n()}}this.serverEventListener=e=>{t.push(e),n()},this.eventService.addListener(this.serverEventListener)}stopServerEventsHandling(){this.eventService.removeListener(this.serverEventListener)}async handleModelChanges(e){if("update-player"===e.type)this.el.money=e.details.update.money;else if("add-unit"===e.type)this.el.field.addUnit(e.details);else if("add-grave"===e.type)this.el.field.addGrave(e.details);else if("update-unit"===e.type){const{id:t,update:i}=e.details;await this.el.field.updateUnit(t,i)}else if("move-unit"===e.type){const{id:t,path:i}=e.details;await this.el.field.moveUnit(t,i)}else if("update-building"===e.type){const{id:t,update:i}=e.details;this.el.field.buildingsLayer.updateBuilding(t,i)}else if("remove-unit"===e.type)this.el.field.removeUnit(e.details);else if("remove-grave"===e.type)this.el.field.removeGrave(e.details);else if("attack"===e.type){const{from:t,to:i}=e.details;await this.el.field.showAttack(t,i)}else if("select-unit"===e.type){const{id:t,actions:i}=e.details;this.el.field.showUnitActions(i)}else if("show-unit-potential-actions"===e.type){const{actions:t}=e.details;this.el.field.showUnitActions(t)}else if("show-unit-info"===e.type)this.el.dialogService.openUnitInfo(e.details);else if("init"===e.type){this.el.field.clear();const{size:t,mapImageDataUrl:i,buildings:s,units:n,graves:o,round:a,player:l,activeUnitsCount:r}=e.details;this.el.field.width=t.width,this.el.field.height=t.height,this.el.field.terrainLayer.setSrc(i),s.forEach((e=>this.el.field.addBuilding(e))),n.forEach((e=>this.el.field.addUnit(e))),o.forEach((e=>this.el.field.addGrave(e))),this.updateBattle(l,a,r),"ai"===l.type&&this.ai.run(l.id)}else if("start-turn"===e.type){const{player:t,round:i,income:s,activeUnitsCount:n}=e.details;this.updateBattle(t,i,n),await this.el.dialogService.openNewTurnPopup({playerName:"Player "+t.id,playerColor:t.color,income:s,round:i,autoClose:1e3}),"ai"===t.type&&this.ai.run(t.id)}else if("active-units-count-change"===e.type){const{activeUnitsCount:t}=e.details;this.el.activeUnitsCount=t}else if("game-end"===e.type){const{victory:t}=e.details;this.el.dialogService.openGameEnd({victory:t});const i=t?"victory.mp3":"game-over.mp3";this.soundService.play({sound:i,roadIndex:0,loop:!1})}else if("player-defeat"===e.type){const{name:t,color:i}=e.details;await this.el.dialogService.openNotification({header:`${t} (${i}) has been defeated`,autoClose:2e3})}else if("center"===e.type)this.el.centerToXY(e.details);else if("open-store"===e.type)this.el.dialogService.openUnitStore(e.details);else if("story"===e.type)window.soundService.play({sound:"bg-story.mp3",roadIndex:0,loop:!0}),await t(e.details.items,(e=>new Promise((t=>{this.el.dialogService.openStory(e),this.el.addEventListener("story-next",(()=>t()))})))),this.el.dialogService.closeStory(),window.soundService.play({sound:"bg-good.mp3",roadIndex:0,loop:!0});else if("conversation"===e.type)await t(e.details.items,(e=>new Promise((t=>{e.cell&&this.el.centerToXY(e.cell),this.el.dialogService.openConversation(e),this.el.addEventListener("conversation-next",(()=>t()))})))),this.el.dialogService.closeConversation();else if("notification"===e.type){const t=e.details.sound;t&&window.soundService.play({sound:t,roadIndex:0,loop:!1}),await this.el.dialogService.openNotification(e.details)}else"open-mission"===e.type&&(await this.api.startMission(e.details.missionId),await this.api.init())}updateBattle(e,t,i){const s="ai"===e.type?"bg-bad.mp3":"bg-good.mp3";this.soundService.play({sound:s,roadIndex:0,loop:!0}),this.el.playerId=e.id,this.el.money=e.money,this.el.color=e.color,this.el.round=t,this.el.activeUnitsCount=i,this.el.clicksDisabled="ai"===e.type,this.el.field.setClicksDisabled("ai"===e.type)}click(e){this.api.click(e)}dblclick(e){this.api.dblclick(e)}longPress(e){this.api.longPress(e)}endTurn(){this.api.endTurn()}suggestSaveName(){return this.api.suggestSaveName()}restart(){this.api.restart()}save(e){this.api.save(e)}buyUnit(e,t){this.api.buyUnit(e,t)}}let h,u,v=e=>e,y=class extends r{constructor(){super(...arguments),this.cellSize=64}render(){return d(h||(h=v` <ae-top-bar playerId="${0}" color="${0}" money="${0}" @top-bar-menu-click="${0}"></ae-top-bar> <ae-field-padding> <ae-battle-field></ae-battle-field> </ae-field-padding> <ae-turn-end-button unitsLeft="${0}" disabled="${0}" @click="${0}"></ae-turn-end-button> `),this.playerId,this.color,this.money,this.openMenu,this.activeUnitsCount,this.clicksDisabled,this.endTurn)}connectedCallback(){super.connectedCallback(),this.ctrl=new p(this),this.dialogService=new c(this.shadowRoot),setTimeout((()=>{this.initListeners(),this.ctrl.init()}))}centerToXY(e){this.container.scrollTo({top:e.y*this.field.cellSize-120,left:e.x*this.field.cellSize-120,behavior:"smooth"})}openMenu(){this.dialogService.openMenu({round:this.round,clicksDisabled:this.clicksDisabled})}openSaveDialog(e){this.dialogService.openSaveDialog(e)}endTurn(){this.dispatchEvent(i("end-turn"))}initListeners(){this.field.addEventListener("single-click",(e=>this.ctrl.click(e.detail))),this.field.addEventListener("double-click",(e=>this.ctrl.dblclick(e.detail))),this.field.addEventListener("long-press",(e=>this.ctrl.longPress(e.detail))),this.addEventListener("end-turn",(()=>this.ctrl.endTurn())),this.addEventListener("menu-save-battle",(()=>this.openSaveDialog(this.ctrl.suggestSaveName()))),this.addEventListener("menu-quit-battle",(()=>this.toMainMenu())),this.addEventListener("menu-restart-battle",(()=>this.ctrl.restart())),this.addEventListener("save-submit",(e=>this.ctrl.save(e.detail.name))),this.addEventListener("unit-store-buy",(({detail:e})=>this.ctrl.buyUnit(e.item,e.storeCell)))}toMainMenu(){this.dispatchEvent(i("route-change",{route:""}))}};y.styles=s(u||(u=v`:host{display:grid;grid-template-rows:auto 1fr auto;position:fixed;top:0;left:0;width:100%;height:100%;background:#242a45}ae-turn-end-button{position:absolute;bottom:10px;right:20px;z-index:10}`)),n([o({type:Number})],y.prototype,"playerId",void 0),n([o({type:Number})],y.prototype,"money",void 0),n([o({type:String})],y.prototype,"color",void 0),n([o({type:Number})],y.prototype,"round",void 0),n([o({type:Number})],y.prototype,"activeUnitsCount",void 0),n([o({type:Number})],y.prototype,"cellSize",void 0),n([o({type:Boolean})],y.prototype,"clicksDisabled",void 0),n([a("ae-field-padding")],y.prototype,"container",void 0),n([a("ae-battle-field")],y.prototype,"field",void 0),y=n([l("ae-battle")],y);
