import{b as e}from"./dd05df28.js";import{u as t}from"./43d81f17.js";window.battleConfigurationService=new class{constructor(e,t,r,s){this.repo=e,this.crudService=t,this.eventService=r,this.pathFinder=s}async preparePreferences(e){let t;t=e.startsWith("mission")?window.maps2[e]:await fetch(`/assets/maps/${e}.json`).then((e=>e.json()));const r=["galamar","valadorn","demon-lord","saeth"],s=["blue","red","green","black"];return{id:e,players:t.players.map(((e,t)=>({...e,color:s[t],commander:r[t]})))}}async create(e){let t;t=e.id.startsWith("mission")?window.maps2[e.id]:await fetch(`/assets/maps/${e.id}.json`).then((e=>e.json()));const r=e.players.map((e=>({id:e.id,type:e.type,color:e.color,teamId:e.teamId,money:e.money,unitLimit:e.unitLimit,wispAura:[],defeated:!1}))),s={id:t.id,type:t.type,size:t.size,i18n:t.i18n,purchasableUnits:t.purchasableUnits,round:1,activePlayerId:1,ended:!1};this.repo.createBattle({battle:s,players:r,terrains:t.terrains,triggers:t.triggers?t.triggers.map((e=>({...e,done:!1}))):[],scripts:t.scripts?t.scripts.map((e=>({...e,done:!1,requires:e.requires||[]}))):[],preferences:e}),t.buildings.map((e=>{const{x:t,y:r,...s}=e;return{cell:{x:t,y:r},...s}})).forEach((e=>this.repo.addBuilding(this.createBuilding(e)))),t.units.map((e=>{const{x:t,y:r,...s}=e;return{cell:{x:t,y:r},...s}})).forEach((e=>this.repo.addUnit(this.createUnit(e))))}save(e){localStorage.setItem(`[saved-battle] ${e} | ${Date.now()}`,this.repo.toJSON())}load(e){const t=localStorage.getItem(e);if(!t)throw new Error(`Save "${e}" not found`);window.battleRepository.fromJSON(t)}restart(){this.create(this.repo.preferences)}suggestSaveName(){const e=this.repo.getBattle().i18n.en.name,t=`[saved-battle] ${e} - `,r=Object.keys(localStorage).filter((e=>e.startsWith(t))).map((e=>parseInt(e.slice(t.length).split("|")[0])||0));return e+" - "+(Math.max(0,...r)+1)}removeExistingAutoSave(){const e=`[saved-battle] ${this.repo.getBattle().i18n.en.name} - auto`,t=Object.keys(localStorage).filter((t=>t.startsWith(e)));for(const e of t)localStorage.removeItem(e)}createBuilding(t){return{...e[t.type],ownerId:null,...t}}createUnit(e){const r=this.repo.getPlayers().find((({id:t})=>t===e.ownerId));let s;if("commander"===e.type){const e=this.repo.preferences.players.find((e=>e.id===r.id));s=null==e?void 0:e.commander}else s=e.type;const a=t[s],i={...e,...a,type:s,active:!0,effects:[]};i.health=e.health||100,i.defaultHealth=100,i.xp=e.xp||0;let n=0;return i.levelList.forEach(((e,t)=>{i.xp>=e&&(n=t)})),i.level=n,i}async startMission(e,t){t||(t=await this.preparePreferences(e)),await this.create(t)}}(window.battleRepository,window.crudService,window.eventService,window.pathFinder);
