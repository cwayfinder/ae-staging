import{u as e,a as t,e as i}from"./43d81f17.js";import{c as n}from"./89a3a3bf.js";import{B as r}from"./dbbb96b8.js";window.apiService=new class{constructor(e,t,i,n,r,s,o,c,a,l,h){this.repo=e,this.battleService=t,this.crudService=i,this.eventService=n,this.pathFinder=r,this.scriptingService=s,this.selectionService=o,this.unitActionExecutor=c,this.battleConfigurationService=a,this.unitStoreService=l,this.unitActionCollector=h}async startMission(e,t){await this.battleConfigurationService.startMission(e,t)}save(e){this.battleConfigurationService.save(e)}suggestSaveName(){return this.battleConfigurationService.suggestSaveName()}restart(){this.battleConfigurationService.restart(),this.init()}endTurn(){this.selectionService.selectUnit(null),"ai"!==this.repo.getActivePlayer().type&&this.autoSave(),this.decrementGravesTtl(),this.repo.getUnits().forEach((e=>this.resetUnitState(e))),this.decrementPoisonCount(),this.activateNextPlayer(),this.startTurn()}autoSave(){this.battleConfigurationService.removeExistingAutoSave();const e=this.repo.getBattle();this.save(e.i18n.en.name+" - auto")}startTurn(){const e=this.repo.getActivePlayer(),t=this.repo.getBattle().round;let i=0;t>1&&(i=this.collectIncome(),this.crudService.updatePlayer(e.id,{money:e.money+i})),this.eventService.emitEvent(new r("battle","start-turn",{player:e,round:t,income:i})),t>1&&this.healthByBuildings(),this.scriptingService.checkTriggers()}decrementGravesTtl(){this.repo.getGraves().forEach((e=>{this.crudService.updateGrave(e.id,{ttl:e.ttl-1}),0===e.ttl&&this.crudService.removeGrave(e.id)}))}resetUnitState(e){this.crudService.updateUnit(e.id,{active:!0,didMove:!1,didAttack:!1,gotBuilding:!1,fixedBuilding:!1})}decrementPoisonCount(){this.repo.getUnits().forEach((e=>{const t=e.effects.find((e=>"poisoned"===e.type));if(t){const i=t.data.rounds;i>1?this.crudService.updateUnitEffect(e.id,"poisoned",{rounds:i-1}):this.crudService.removeUnitEffect(e.id,"poisoned")}}))}activateNextPlayer(){const e=this.repo.getPlayers(),t=this.repo.getBattle();let i=(e.findIndex((e=>e.id===t.activePlayerId))+1)%e.length;const n=this.repo.getPlayers()[i];this.repo.updateBattle({activePlayerId:n.id}),0===i&&this.crudService.updateBattle({round:t.round+1}),n.defeated&&this.activateNextPlayer()}collectIncome(){const e=this.repo.getActivePlayer();return this.repo.getBuildings({ownerId:e.id}).reduce(((e,t)=>e+(t.earn||0)),0)}healthByBuildings(){this.repo.getUnits().filter((e=>e.ownerId===this.repo.getBattle().activePlayerId)).forEach((e=>{this.healthUpByBuilding(e)}))}healthUpByBuilding(e){const t=this.repo.getBuildingHeal({cell:e.cell,playerId:e.ownerId});if(t){let i=e.defaultHealth-e.health;i=Math.min(i,t),i&&this.crudService.updateUnit(e.id,{health:e.health+i})}}getUnitInfo(n){const r=this.repo.getUnit({id:n});if(!r)throw new Error(`Unit with id ${n} not found`);const s=this.repo.getPlayer({id:r.ownerId}),o=r.level,c=Math.min(o+1,r.levelList.length-1),a=r.levelList[o],l=r.levelList[c],h=e[r.type],d=r.abilities.map((e=>t[e].i18n.en)),v=r.effects.map((e=>({...i[e.type].i18n.en,...e})));return{type:r.type,name:h.i18n.en.name,description:h.i18n.en.description,color:s.color,atk:r.atk,def:r.def,cellDef:this.battleService.getDefByTerrain(r),mov:r.mov,health:r.health,maxHealth:r.defaultHealth,level:o,nextLevel:c,xp:r.xp,xpForCurrentLevel:a,xpForNextLevel:l,abilities:d,effects:v}}click(e){const t=null===this.selectionService.unitId?null:this.repo.getUnit({id:this.selectionService.unitId}),i=this.selectionService.unitActions,n=this.repo.getActivePlayer(),r=i.find((t=>t.cell.x===e.x&&t.cell.y===e.y)),s=this.repo.getUnit({cell:e}),o=this.repo.getBuilding({cell:e});if(r&&"remain"!==r.type)this.selectionService.selectUnit(null),this.executeUnitAction(t,r);else if(s&&s.id===(null==t?void 0:t.id)&&o&&"castle"===o.type&&o.ownerId===n.id)this.selectionService.selectUnit(null),this.openStore(e);else{const r=i.find((e=>"undo-move"===e.type));if(r&&(this.selectionService.selectUnit(null),this.executeUnitAction(t,r)),s&&s.active&&s.ownerId===n.id){const t=[];o&&"castle"===o.type&&o.ownerId===n.id&&t.push({cell:e,type:"open-store"}),this.selectionService.selectUnit(s.id,t)}else o&&"castle"===o.type&&o.ownerId===n.id?(this.openStore(e),this.selectionService.selectUnit(null)):this.selectionService.selectUnit(null)}}dblclick(e){const t=this.repo.getUnit({cell:e});if(t){const e=this.getPotentialAttackActions(t.id);this.eventService.emitEvent(new r("field","show-unit-potential-actions",{actions:e}))}}longPress(e){const t=this.repo.getUnit({cell:e});if(t){const e=this.getUnitInfo(t.id);this.eventService.emitEvent(new r("field","show-unit-info",e))}}executeUnitAction(e,t){this.unitActionExecutor.execute(e,t),["move","undo-move"].includes(t.type)||(this.scriptingService.checkTriggers(),"skirmish"===this.repo.getBattle().type&&this.scriptingService.checkPlayerDefeat())}openStore(e){this.eventService.emitEvent(new r("battle","open-store",{storeCell:e}))}reviveUnit(e,t){this.unitStoreService.reviveUnit(e,t)}purchaseUnit(e,t){this.unitStoreService.buyUnit(e,t)}getStoreData(e){return{tooMany:this.unitStoreService.isUnitsTooMuch(),player:this.repo.getActivePlayer(),purchasableUnits:this.unitStoreService.getPurchasableUnits(),revivableUnits:this.unitStoreService.getRevivableUnits()}}getPotentialAttackActions(e){return this.unitActionCollector.getPotentialAttackActions(e)}async init(){await this.initBattle(),await this.scriptingService.checkTriggers()}async initBattle(){this.pathFinder.init(),this.repo.getPlayers().forEach((e=>this.crudService.refreshWispAura(e.id))),this.repo.getUnits().forEach((e=>this.crudService.refreshUnitEffects(e)));const e=this.repo.getBattle(),t=await n(e.size,this.repo.getTerrains(),this.repo.getBuildings());this.eventService.emitEvent(new r("battle","init",{size:e.size,mapImageDataUrl:t,buildings:this.repo.getBuildings().map((e=>this.crudService.createBuildingVo(e))),units:this.repo.getUnits().map((e=>this.crudService.createUnitVo(e))),graves:this.repo.getGraves().map((e=>this.crudService.createGraveVo(e))),round:e.round,type:e.type,player:this.repo.getActivePlayer()}))}}(window.battleRepository,window.battleService,window.crudService,window.eventService,window.pathFinder,window.scriptingService,window.selectionService,window.unitActionExecutor,window.battleConfigurationService,window.unitStoreService,window.unitService);
