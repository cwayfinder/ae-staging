import{u as e}from"./fbfb0d48.js";import{t}from"./fcafee02.js";import{d as a}from"./eeb3eefa.js";window.battleService=new class{constructor(e,t){this.repo=e,this.pathFinder=t}calculateDamage(t,a){if(a.health<=0)return{min:0,max:0};const i=this.getTerrainType(t.cell),l=this.getTerrainType(a.cell);let r=0;r+=2*t.level,e(t,"inspired")&&(r+=10),e(t,"poisoned")&&(r-=10),t.abilities.includes("waterborne")&&"water"===i&&(r+=10),t.abilities.includes("marksman")&&a.abilities.includes("airborne")&&(r+=30),t.abilities.includes("warriorOfLight")&&a.abilities.includes("undead")&&(r+=30);let n=a.def;n+=2*a.level,e(a,"poisoned")&&(n-=10),a.abilities.includes("waterborne")&&"water"===l&&(n+=15),n+=this.getArmorByXY(a.cell);const s=t.health/t.defaultHealth;return{min:Math.max((t.atk.min+r-n)*s,1),max:Math.max((t.atk.max+r-n)*s,1)}}getTerrainType(e){return this.repo.getTerrains()[`x${e.x}y${e.y}`].replace(/\-\d+$/,"")}getArmorByXY(e){const a=this.repo.getBuilding({cell:e});if(a)return a.defence;const i=this.getTerrainType(e);return t[i].defence}getDefByTerrain(e){const t=this.getTerrainType(e.cell);return e.abilities.includes("waterborne")&&"water"===t?15:this.getArmorByXY(e.cell)}canStrikeBack(e,t){if("crystal"===e.type||"catapult"===e.type)return!1;return Math.abs(e.cell.x-t.cell.x)+Math.abs(e.cell.y-t.cell.y)<=1}calculateAttackData(e,t){const a=this.calculateDamage(e,t),i=this.calculateKillProbability(a,t.health);let l=null,r=0;if(i<1&&this.canStrikeBack(t,e)){const i=t.health;t.health=Math.max(i-a.min,0);const n=this.calculateDamage(t,e).max;t.health=Math.max(i-a.max,0);const s=this.calculateDamage(t,e).min;t.health=i,l={min:s,max:n},r=this.calculateKillProbability(l,e.health)}return{dmg:a,killProbability:i,responseDmg:l,suicideProbability:r}}calculateKillProbability(e,t){const a=(t-e.min)/(e.max-e.min);return 1-Math.min(Math.max(a,0),1)}getClosestAvailableCell(e){const t=this.repo.getBattle().size;let i=[];for(let e=0;e<t.width;e+=1)for(let a=0;a<t.height;a+=1){const t={x:e,y:a};this.repo.getUnit({cell:t})||i.push(t)}return i=i.sort(((t,i)=>a(e,t)-a(e,i))),i[0]}getWispAuraMap(e){return this.pathFinder.getReachableCells({start:e.cell,range:e.auraRange,moveType:"none"}).map((e=>e.cell))}playerHasCastle(e){const t=this.repo.getBuildings({ownerId:e,type:"castle"});if(!t.length)return!1;if(t.filter((e=>!this.repo.getUnit({cell:e.cell,enemy:e.ownerId}))).length)return!0;return!!this.repo.getUnits({ally:e}).length}playerHasCommander(e){return this.repo.getUnits({ownerId:e}).some((e=>e.abilities.includes("commander")))}}(window.battleRepository,window.pathFinder);
