import{u as e}from"./43d81f17.js";import{i as t}from"./eeb3eefa.js";import{B as i}from"./dbbb96b8.js";window.crudService=new class{constructor(e,t,i){this.repo=e,this.battleService=t,this.eventService=i}addUnit(e){e.cell=this.battleService.getClosestAvailableCell(e.cell);const t=this.repo.addUnit(this.createUnit(e));return this.emitModelEvent("add-unit",this.createUnitVo(t)),"wisp"===t.type&&(this.refreshWispAura(t.ownerId),this.repo.getUnits({ally:t.ownerId}).forEach((e=>this.refreshUnitEffects(e)))),this.refreshUnitEffects(t),t}createBuildingVo(e){const t=null===e.ownerId?null:this.repo.getPlayer({id:e.ownerId});return{id:e.id,cell:e.cell,type:e.type,color:t&&t.color,state:e.state}}createBuildingUpdateVo(e){const t={};for(const[i,r]of Object.entries(e))if("ownerId"===i){const i=null===e.ownerId?null:this.repo.getPlayer({id:e.ownerId});t.color=i?i.color:null}else t[i]=r;return t}createUnitVo(e){const t=this.repo.getPlayer({id:e.ownerId});return{id:e.id,cell:e.cell,type:e.type,color:t.color,health:e.health,defaultHealth:e.defaultHealth,active:e.active,level:e.level,effects:e.effects.map((e=>e.type))}}createUnitUpdateVo(e){var t;const i={};for(const[r,o]of Object.entries(e))if("ownerId"===r){const t=this.repo.getPlayer({id:e.ownerId});i.color=t.color}else"effects"===r?i.effects=null===(t=e.effects)||void 0===t?void 0:t.map((e=>e.type)):i[r]=o;return i}createGraveVo(e){return{id:e.id,cell:e.cell}}createUnit(t){const i=this.repo.getPlayer({id:t.ownerId});if(!i)throw new Error("Cannot fing player with id "+t.ownerId);let r;if("commander"===t.type){const e=this.repo.preferences.players.find((e=>e.id===i.id));r=null==e?void 0:e.commander}else r=t.type;const o=e[r],n={...t,...o,type:r,active:!0,effects:[]};n.health=t.health||100,n.defaultHealth=100,n.xp=t.xp||0;let s=0;return n.levelList.forEach(((e,t)=>{n.xp||(n.xp=0),n.xp>=e&&(s=t)})),n.level=s,n}addGrave({cell:e}){const t=this.repo.addGrave({cell:e,ttl:3}),i={id:t.id,cell:t.cell};this.emitModelEvent("add-grave",i)}updateBattle(e){this.repo.updateBattle(e),this.emitModelEvent("update-battle",e)}updateBuilding(e,t){this.repo.updateBuilding(e,t),this.emitModelEvent("update-building",{id:e,update:this.createBuildingUpdateVo(t)})}updateUnit(e,t,i=!0){const r=this.repo.getUnit({id:e});if("xp"in t){let e=r.level;r.levelList.forEach(((t,i)=>{r.xp>=t&&(e=i)})),t.level=e}return this.repo.updateUnit(e,t),i&&this.emitModelEvent("update-unit",{id:e,update:t}),"cell"in t&&("wisp"===r.type?(this.refreshWispAura(r.ownerId),this.repo.getUnits({ally:r.ownerId}).forEach((e=>this.refreshUnitEffects(e)))):this.refreshUnitEffects(r)),r}updateGrave(e,t){this.repo.updateGrave(e,t),this.emitModelEvent("update-grave",{id:e,update:t})}updatePlayer(e,t){this.repo.updatePlayer(e,t),e===this.repo.getBattle().activePlayerId&&this.emitModelEvent("update-player",{id:e,update:t})}removeUnit(e){const t=this.repo.getUnit({id:e},!0);if(this.repo.removeUnit(e),this.emitModelEvent("remove-unit",e),!t)throw new Error(`Unit with id ${e} not found`);"wisp"===t.type&&(this.refreshWispAura(t.ownerId),this.repo.getUnits({ally:t.ownerId}).forEach((e=>this.refreshUnitEffects(e))))}removeGrave(e){this.repo.removeGrave(e),this.emitModelEvent("remove-grave",e)}addUnitEffect(e,t){const i=this.repo.getUnit({id:e});if(!i)throw new Error(`Unit with id ${e} not found`);const r=i.effects.find((e=>e.type===t.type));r?"poisoned"===t.type&&(r.data.rounds=Math.max(r.data.rounds,t.data.rounds),this.emitModelEvent("update-unit-effect",{unitId:i.id,currentEffect:r})):(i.effects.push(t),this.emitModelEvent("update-unit",{id:e,update:{effects:i.effects.map((e=>e.type))}}))}updateUnitEffect(e,t,i){const r=this.repo.getUnit({id:e});if(!r)throw new Error(`Unit with id ${e} not found`);const o=r.effects.find((e=>e.type===t));if(!o)throw new Error("Unit has no effect with type "+t);o.data=i,this.emitModelEvent("update-unit-effect",{unitId:r.id,effect:o})}removeUnitEffect(e,t){const i=this.repo.getUnit({id:e});if(!i)throw new Error(`Unit with id ${e} not found`);i.effects.some((e=>e.type===t))&&(i.effects=i.effects.filter((e=>e.type!==t)),this.emitModelEvent("update-unit",{id:e,update:{effects:i.effects.map((e=>e.type))}}))}refreshWispAura(e){const t=this.repo.getUnits({ownerId:e,type:"wisp"}).map((e=>this.battleService.getWispAuraMap(e))).flat();this.updatePlayer(e,{wispAura:t})}refreshUnitEffects(e){const i=this.repo.getPlayers({ally:e.ownerId}).map((e=>e.wispAura)).flat();t(i,e.cell)?this.addUnitEffect(e.id,{type:"inspired",data:{}}):this.removeUnitEffect(e.id,"inspired")}emitModelEvent(e,t){this.eventService.emitEvent(new i("crud",e,t))}}(window.battleRepository,window.battleService,window.eventService);
