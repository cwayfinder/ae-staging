import{d as e}from"./fbfb0d48.js";import{c as t}from"./d1ada6f5.js";import{c as i,_ as n,p as s,q as a,a as o,L as l,h as r}from"./f0da52c9.js";class d{constructor(e){this.parent=e}openMenu(e){const t=document.createElement("ae-battle-menu");t.round=e.round,t.clicksDisabled=e.clicksDisabled,this.parent.append(t)}openNewTurnPopup(e){return new Promise((t=>{const i=document.createElement("ae-new-turn");i.round=e.round,i.playerName=e.playerName,i.playerColor=e.playerColor,i.income=e.income,i.addEventListener("new-turn-close",(()=>t())),this.parent.append(i),e.autoClose&&setTimeout((()=>i.close()),e.autoClose)}))}openStory(e){return new Promise((t=>{const i=document.createElement("ae-story");i.text=e.content,i.illustration=e.illustration,i.addEventListener("story-next",(()=>t())),this.parent.append(i)}))}openNotification(e){return new Promise((t=>{const i=document.createElement("ae-notification");i.header=e.header,i.text=e.content,i.addEventListener("notification-close",(()=>t())),this.parent.append(i),e.autoClose&&setTimeout((()=>i.close()),e.autoClose)}))}openConversation(e){return new Promise((t=>{const i=document.createElement("ae-conversation");i.character=e.character,i.position=e.position,i.text=e.text,i.addEventListener("conversation-close",(()=>t())),this.parent.append(i)}))}openGameEnd(e){const t=document.createElement("ae-game-end");t.victory=e.victory,this.parent.append(t)}openSaveDialog(e){const t=document.createElement("ae-dialog");t.type="save";const i=document.createElement("ae-save-battle");i.name=e,i.addEventListener("save-submit",(()=>t.close())),i.addEventListener("save-cancel",(()=>t.close())),t.append(i),this.parent.append(t)}openUnitStore(e){const t=document.createElement("ae-unit-store");t.units=e.units,t.color=e.color,t.money=e.money,t.storeCell=e.storeCell,this.parent.append(t)}openUnitInfo(e){const t=document.createElement("ae-unit-info");t.unit=e,this.parent.append(t)}}class c{constructor(e){this.el=e,this.eventService=window.eventService,this.api=window.apiService,this.soundService=window.soundService,this.ai=window.ai}init(){this.startServerEventsHandling(),this.api.init()}startServerEventsHandling(){const t=[];let i=!1;const n=this;async function s(){if(!i&&t.length){const a=t.shift();i=!0,await e(0),await n.handleModelChanges(a),i=!1,s()}}this.serverEventListener=e=>{t.push(e),s()},this.eventService.addListener(this.serverEventListener)}stopServerEventsHandling(){this.eventService.removeListener(this.serverEventListener)}async handleModelChanges(e){if("update-player"===e.type)this.el.money=e.details.update.money;else if("add-unit"===e.type)this.el.field.addUnit(e.details);else if("add-grave"===e.type)this.el.field.addGrave(e.details);else if("update-unit"===e.type){const{id:t,update:i}=e.details;await this.el.field.updateUnit(t,i)}else if("move-unit"===e.type){const{id:t,path:i}=e.details;await this.el.field.moveUnit(t,i)}else if("update-building"===e.type){const{id:t,update:i}=e.details;this.el.field.buildingsLayer.updateBuilding(t,i)}else if("remove-unit"===e.type)this.el.field.removeUnit(e.details);else if("remove-grave"===e.type)this.el.field.removeGrave(e.details);else if("attack"===e.type){const{from:t,to:i}=e.details;await this.el.field.showAttack(t,i)}else if("select-unit"===e.type){const{id:t,actions:i}=e.details;this.el.field.showUnitActions(i)}else if("show-unit-potential-actions"===e.type){const{actions:t}=e.details;this.el.field.showUnitActions(t)}else if("show-unit-info"===e.type)this.el.openUnitInfo(e.details);else if("init"===e.type){this.el.field.clear();const{size:t,mapImageDataUrl:i,buildings:n,units:s,graves:a,round:o,player:l,activeUnitsCount:r}=e.details;this.el.field.width=t.width,this.el.field.height=t.height,this.el.field.terrainLayer.setSrc(i),n.forEach((e=>this.el.field.addBuilding(e))),s.forEach((e=>this.el.field.addUnit(e))),a.forEach((e=>this.el.field.addGrave(e))),this.updateBattle(l,o,r),"ai"===l.type&&this.ai.run(l.id)}else if("start-turn"===e.type){const{player:t,round:i,income:n,activeUnitsCount:s}=e.details;this.updateBattle(t,i,s),await this.el.openNewTurnPopup({playerName:"Player "+t.id,playerColor:t.color,income:n,round:i,autoClose:1e3}),"ai"===t.type&&this.ai.run(t.id)}else if("active-units-count-change"===e.type){const{activeUnitsCount:t}=e.details;this.el.activeUnitsCount=t}else if("game-end"===e.type){const{victory:t}=e.details;this.el.openGameEnd({victory:t});const i=t?"victory.mp3":"game-over.mp3";this.soundService.play({sound:i,roadIndex:0,loop:!0})}else if("player-defeat"===e.type){const{name:t,color:i}=e.details;await this.el.openNotification({header:`${t} (${i}) has been defeated`,autoClose:2e3})}else"center"===e.type?this.el.centerToXY(e.details):"open-store"===e.type?this.el.openUnitStore(e.details):"story"===e.type?await this.el.openStory(e.details):"conversation"===e.type?(e.details.cell&&this.el.centerToXY(e.details.cell),await this.el.openConversation(e.details)):"notification"===e.type?await this.el.openNotification(e.details):"open-mission"===e.type&&(await this.api.startMission(e.details.missionId),await this.api.init())}updateBattle(e,t,i){const n="ai"===e.type?"bg-bad.mp3":"bg-good.mp3";this.soundService.play({sound:n,roadIndex:0,loop:!0}),this.el.playerId=e.id,this.el.money=e.money,this.el.color=e.color,this.el.round=t,this.el.activeUnitsCount=i,this.el.clicksDisabled="ai"===e.type,this.el.field.setClicksDisabled("ai"===e.type)}click(e){this.api.click(e)}dblclick(e){this.api.dblclick(e)}longPress(e){this.api.longPress(e)}endTurn(){this.api.endTurn()}suggestSaveName(){return this.api.suggestSaveName()}restart(){this.api.restart()}save(e){this.api.save(e)}buyUnit(e,t){this.api.buyUnit(e,t)}}let p,h,u=e=>e,v=class extends l{constructor(){super(...arguments),this.cellSize=64}render(){return r(p||(p=u` <ae-top-bar playerId="${0}" color="${0}" money="${0}" @top-bar-menu-click="${0}"></ae-top-bar> <ae-field-padding> <ae-battle-field></ae-battle-field> </ae-field-padding> <ae-turn-end-button unitsLeft="${0}" disabled="${0}" @click="${0}"></ae-turn-end-button> `),this.playerId,this.color,this.money,this.openMenu,this.activeUnitsCount,this.clicksDisabled,this.endTurn)}connectedCallback(){super.connectedCallback(),this.ctrl=new c(this),this.dialogService=new d(this.shadowRoot),setTimeout((()=>{this.initListeners(),this.ctrl.init()}))}centerToXY(e){this.container.scrollTo({top:e.y*this.field.cellSize-120,left:e.x*this.field.cellSize-120,behavior:"smooth"})}openMenu(){this.dialogService.openMenu({round:this.round,clicksDisabled:this.clicksDisabled})}openNewTurnPopup(e){return this.dialogService.openNewTurnPopup(e)}openStory(e){return this.dialogService.openStory(e)}openNotification(e){return this.dialogService.openNotification(e)}openConversation(e){return this.dialogService.openConversation(e)}openGameEnd(e){this.dialogService.openGameEnd(e)}openSaveDialog(e){this.dialogService.openSaveDialog(e)}openUnitStore(e){this.dialogService.openUnitStore(e)}openUnitInfo(e){this.dialogService.openUnitInfo(e)}endTurn(){this.dispatchEvent(t("end-turn"))}updated(){this.field.scrollIntoView({block:"center"})}initListeners(){this.field.addEventListener("single-click",(e=>this.ctrl.click(e.detail))),this.field.addEventListener("double-click",(e=>this.ctrl.dblclick(e.detail))),this.field.addEventListener("long-press",(e=>this.ctrl.longPress(e.detail))),this.addEventListener("end-turn",(()=>this.ctrl.endTurn())),this.addEventListener("menu-save-battle",(()=>this.openSaveDialog(this.ctrl.suggestSaveName()))),this.addEventListener("menu-quit-battle",(()=>this.toMainMenu())),this.addEventListener("menu-restart-battle",(()=>this.ctrl.restart())),this.addEventListener("save-submit",(e=>this.ctrl.save(e.detail.name))),this.addEventListener("unit-store-buy",(({detail:e})=>this.ctrl.buyUnit(e.item,e.storeCell)))}toMainMenu(){this.dispatchEvent(t("route-change",{route:""}))}};v.styles=i(h||(h=u`:host{display:grid;grid-template-rows:auto 1fr auto;position:fixed;top:0;left:0;width:100%;height:100%;background:#242a45}ae-turn-end-button{position:absolute;bottom:10px;right:20px;z-index:1}`)),n([s({type:Number})],v.prototype,"playerId",void 0),n([s({type:Number})],v.prototype,"money",void 0),n([s({type:String})],v.prototype,"color",void 0),n([s({type:Number})],v.prototype,"round",void 0),n([s({type:Number})],v.prototype,"activeUnitsCount",void 0),n([s({type:Number})],v.prototype,"cellSize",void 0),n([s({type:Boolean})],v.prototype,"clicksDisabled",void 0),n([a("ae-field-padding")],v.prototype,"container",void 0),n([a("ae-battle-field")],v.prototype,"field",void 0),v=n([o("ae-battle")],v);
