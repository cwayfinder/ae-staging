import{d as e}from"./fbfb0d48.js";import{c as t}from"./d1ada6f5.js";window.BattleView=class{constructor(e,i,a,s,l,n){this.battle=e,this.repo=i,this.eventService=a,this.apiService=s,this.ai=l,this.soundService=n,this.battle.field.addEventListener("single-click",(e=>this.apiService.click(e.detail))),this.battle.field.addEventListener("double-click",(e=>{const t=this.repo.getUnit({cell:e.detail});t&&this.showUnitPotentialActions(t)})),this.battle.field.addEventListener("long-press",(e=>{const t=this.repo.getUnit({cell:e.detail});if(t){const e=this.apiService.getUnitInfo(t.id);this.battle.openUnitInfo(e)}})),this.battle.addEventListener("end-turn",(()=>this.apiService.endTurn())),this.battle.addEventListener("menu-save-battle",(()=>{this.battle.openSaveDialog(this.apiService.suggestSaveName())})),this.battle.addEventListener("menu-quit-battle",(()=>this.battle.dispatchEvent(t("route-change",{route:""})))),this.battle.addEventListener("menu-restart-battle",(()=>this.apiService.restart())),this.battle.addEventListener("save-submit",(e=>this.apiService.save(e.detail.name))),this.battle.addEventListener("unit-store-revive",(({detail:e})=>{this.apiService.reviveUnit(e.id,e.storeCell)})),this.battle.addEventListener("unit-store-purchase",(({detail:e})=>{this.apiService.purchaseUnit(e.type,e.storeCell)}))}initBattle(){this.apiService.init()}showAttack({from:e,to:t}){return this.battle.field.showAttack(e,t)}centerToXY(e){this.battle.centerToXY(e)}showUnitPotentialActions(e){const t=this.apiService.getPotentialAttackActions(e.id);this.battle.field.showUnitActions(t)}startServerEventsHandling(){const t=[];let i=!1;const a=this;async function s(){if(!i&&t.length){const l=t.shift();i=!0,await e(0),await a.handleModelChanges(l),i=!1,s()}}this.serverEventListener=e=>{t.push(e),s()},this.eventService.addListener(this.serverEventListener)}stopServerEventsHandling(){this.eventService.removeListener(this.serverEventListener)}async handleModelChanges(e){if("update-player"===e.type){e.details.id===this.repo.getBattle().activePlayerId&&(this.battle.money=this.repo.getActivePlayer().money)}else if("add-unit"===e.type)this.addUnitToView(e.details);else if("add-grave"===e.type)this.addGraveToView(e.details);else if("update-unit"===e.type){const{id:t,update:i}=e.details;"isActive"in i&&(i.active=i.isActive),await this.battle.field.updateUnit(t,i)}else if("move-unit"===e.type){const{id:t,path:i}=e.details;await this.battle.field.moveUnit(t,i)}else if("update-building"===e.type){const{id:t,update:i}=e.details;if("ownerId"in i){const e=this.repo.getPlayer({id:i.ownerId});i.color=e?e.color:null}this.battle.field.buildingsLayer.updateBuilding(t,i)}else if("remove-unit"===e.type)this.battle.field.removeUnit(e.details);else if("remove-grave"===e.type)this.battle.field.removeGrave(e.details);else if("attack"===e.type){const{from:t,to:i}=e.details;await this.showAttack({from:t,to:i})}else if("select-unit"===e.type){const{id:t,actions:i}=e.details;this.battle.field.showUnitActions(i)}else if("init"===e.type){this.battle.field.clear();const{size:t,mapImageDataUrl:i,buildings:a,units:s,graves:l,round:n,player:o}=e.details;this.battle.field.width=t.width,this.battle.field.height=t.height,this.battle.field.terrainLayer.setSrc(i),a.forEach((e=>this.addBuildingToView(e))),s.forEach((e=>this.addUnitToView(e))),l.forEach((e=>this.addGraveToView(e)));const d="ai"===o.type?"bg-bad.mp3":"bg-good.mp3";this.soundService.play({sound:d,roadIndex:0,loop:!0}),this.battle.playerId=o.id,this.battle.money=o.money,this.battle.color=o.color,this.battle.round=n,this.battle.showEndTurnButton="ai"!==o.type,this.battle.field.setClicksDisabled("ai"===o.type),"ai"===o.type&&this.ai.run(o.id)}else if("start-turn"===e.type){const{player:t,round:i,income:a}=e.details,s="ai"===t.type?"bg-bad.mp3":"bg-good.mp3";this.soundService.play({sound:s,roadIndex:0,loop:!0}),this.battle.playerId=t.id,this.battle.money=t.money,this.battle.color=t.color,this.battle.round=i,this.battle.showEndTurnButton="ai"!==t.type,this.battle.field.setClicksDisabled("ai"===t.type);this.repo.getUnits({ownerId:t.id},!0).find((e=>e.abilities.includes("commander")));await this.battle.openNewTurnPopup({playerName:"Player "+t.id,playerColor:t.color,income:a,round:i,autoClose:1e3}),"ai"===t.type&&this.ai.run(t.id)}else if("game-end"===e.type){const{victory:t}=e.details;this.battle.openGameEnd({victory:t});const i=t?"victory.mp3":"game-over.mp3";this.soundService.play({sound:i,roadIndex:0,loop:!0})}else if("player-defeat"===e.type){const{name:t,color:i}=e.details;await this.battle.openNotification({header:`${t} (${i}) has been defeated`,autoClose:2e3})}else"center"===e.type?this.centerToXY(e.details):"open-store"===e.type?this.openStore(e.details.storeCell):"story"===e.type?await this.battle.openStory(e.details):"conversation"===e.type?(e.details.cell&&this.battle.centerToXY(e.details.cell),await this.battle.openConversation(e.details)):"notification"===e.type?await this.battle.openNotification(e.details):"open-mission"===e.type&&await this.apiService.startMission(e.details.missionId)}addBuildingToView(e){const t=null===e.ownerId?null:this.repo.getPlayer({id:e.ownerId});this.battle.field.buildingsLayer.addBuilding({id:e.id,cell:e.cell,type:e.type,color:t&&t.color,state:e.state})}addUnitToView(e){const t=this.repo.getPlayer({id:e.ownerId});this.battle.field.addUnit({id:e.id,cell:e.cell,type:e.type,color:t.color,health:e.health,defaultHealth:e.defaultHealth,active:e.isActive,level:e.level,effects:e.effects})}addGraveToView(e){this.battle.field.addGrave({id:e.id,cell:e.cell})}openStore(e){const{tooMany:t,player:i,purchasableUnits:a,revivableUnits:s}=this.apiService.getStoreData(e);this.battle.openUnitStore({units:[...s,...a],color:i.color,money:i.money,storeCell:e})}};
