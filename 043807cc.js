import{b as e}from"./dd05df28.js";import{u as t}from"./8b91577e.js";import{c as r}from"./91670b66.js";import{B as i}from"./dbbb96b8.js";window.battleConfigurationService=new class{constructor(e,t,r,i){this.repo=e,this.crudService=t,this.eventService=r,this.pathFinder=i}async preparePreferences(e){let t;t=e.startsWith("mission")?window.maps2[e]:await fetch(`/assets/maps/${e}.json`).then((e=>e.json()));const r=["galamar","valadorn","demon-lord","saeth"],i=["blue","red","green","black"];return{id:e,players:t.players.map(((e,t)=>({...e,color:i[t],commander:r[t]})))}}async create(e){let t;t=e.id.startsWith("mission")?window.maps2[e.id]:await fetch(`/assets/maps/${e.id}.json`).then((e=>e.json()));const r=e.players.map((e=>({id:e.id,type:e.type,color:e.color,teamId:e.teamId,money:e.money,unitLimit:e.unitLimit,wispAura:[],defeated:!1}))),i={id:t.id,type:t.type,size:t.size,i18n:t.i18n,purchasableUnits:t.purchasableUnits,round:1,activePlayerId:1,ended:!1};this.repo.createBattle({battle:i,players:r,terrains:t.terrains,triggers:t.triggers?t.triggers.map((e=>({...e,done:!1}))):[],scripts:t.scripts?t.scripts.map((e=>({...e,done:!1,requires:e.requires||[]}))):[],preferences:e}),t.buildings.map((e=>{const{x:t,y:r,...i}=e;return{cell:{x:t,y:r},...i}})).forEach((e=>this.repo.addBuilding(this.createBuilding(e)))),t.units.map((e=>{const{x:t,y:r,...i}=e;return{cell:{x:t,y:r},...i}})).forEach((e=>this.repo.addUnit(this.createUnit(e))))}save(e){localStorage.setItem(`[saved-battle] ${e} | ${Date.now()}`,this.repo.toJSON())}load(e){const t=localStorage.getItem(e);if(!t)throw new Error(`Save "${e}" not found`);window.battleRepository.fromJSON(t)}restart(){this.create(this.repo.preferences)}suggestSaveName(){const e=this.repo.getBattle().i18n.en.name,t=`[saved-battle] ${e} - `,r=Object.keys(localStorage).filter((e=>e.startsWith(t))).map((e=>parseInt(e.slice(t.length).split("|")[0])||0));return e+" - "+(Math.max(0,...r)+1)}removeExistingAutoSave(){const e=`[saved-battle] ${this.repo.getBattle().i18n.en.name} - auto`,t=Object.keys(localStorage).filter((t=>t.startsWith(e)));for(const e of t)localStorage.removeItem(e)}createBuilding(t){return{...e[t.type],ownerId:null,...t}}createUnit(e){const r=this.repo.getPlayers().find((({id:t})=>t===e.ownerId));let i;if("commander"===e.type){const e=this.repo.preferences.players.find((e=>e.id===r.id));i=null==e?void 0:e.commander}else i=e.type;const s=t[i],a={...e,...s,type:i,isActive:!0,effects:[]};a.health=e.health||100,a.defaultHealth=100,a.xp=e.xp||0;let n=0;return a.levelList.forEach(((e,t)=>{a.xp>=e&&(n=t)})),a.level=n,a}async startMission(e,t){t||(t=await this.preparePreferences(e)),await this.create(t),await this.init()}async init(){this.pathFinder.init(),this.repo.getPlayers().forEach((e=>this.crudService.refreshWispAura(e.id))),this.repo.getUnits().forEach((e=>this.crudService.refreshUnitEffects(e)));const e=this.repo.getBattle(),t=await r(e.size,this.repo.getTerrains(),this.repo.getBuildings());this.eventService.emitEvent(new i("battle","init",{size:e.size,mapImageDataUrl:t,buildings:this.repo.getBuildings(),units:this.repo.getUnits(),graves:this.repo.getGraves(),round:e.round,type:e.type,player:this.repo.getActivePlayer()}))}}(window.battleRepository,window.crudService,window.eventService,window.pathFinder);
