import{d as t}from"./fbfb0d48.js";import{c as e}from"./d1ada6f5.js";window.BattleView=class{constructor(t,i,a,s,l){this.battle=t,this.eventService=i,this.api=a,this.ai=s,this.soundService=l,this.battle.field.addEventListener("single-click",(t=>this.api.click(t.detail))),this.battle.field.addEventListener("double-click",(t=>this.api.dblclick(t.detail))),this.battle.field.addEventListener("long-press",(t=>this.api.longPress(t.detail))),this.battle.addEventListener("end-turn",(()=>this.api.endTurn())),this.battle.addEventListener("menu-save-battle",(()=>{this.battle.openSaveDialog(this.api.suggestSaveName())})),this.battle.addEventListener("menu-quit-battle",(()=>this.battle.dispatchEvent(e("route-change",{route:""})))),this.battle.addEventListener("menu-restart-battle",(()=>this.api.restart())),this.battle.addEventListener("save-submit",(t=>this.api.save(t.detail.name))),this.battle.addEventListener("unit-store-revive",(({detail:t})=>{this.api.reviveUnit(t.id,t.storeCell)})),this.battle.addEventListener("unit-store-purchase",(({detail:t})=>{this.api.purchaseUnit(t.type,t.storeCell)}))}initBattle(){this.api.init()}startServerEventsHandling(){const e=[];let i=!1;const a=this;async function s(){if(!i&&e.length){const l=e.shift();i=!0,await t(0),await a.handleModelChanges(l),i=!1,s()}}this.serverEventListener=t=>{e.push(t),s()},this.eventService.addListener(this.serverEventListener)}stopServerEventsHandling(){this.eventService.removeListener(this.serverEventListener)}async handleModelChanges(t){if("update-player"===t.type)this.battle.money=t.details.update.money;else if("add-unit"===t.type)this.battle.field.addUnit(t.details);else if("add-grave"===t.type)this.battle.field.addGrave(t.details);else if("update-unit"===t.type){const{id:e,update:i}=t.details;await this.battle.field.updateUnit(e,i)}else if("move-unit"===t.type){const{id:e,path:i}=t.details;await this.battle.field.moveUnit(e,i)}else if("update-building"===t.type){const{id:e,update:i}=t.details;this.battle.field.buildingsLayer.updateBuilding(e,i)}else if("remove-unit"===t.type)this.battle.field.removeUnit(t.details);else if("remove-grave"===t.type)this.battle.field.removeGrave(t.details);else if("attack"===t.type){const{from:e,to:i}=t.details;await this.battle.field.showAttack(e,i)}else if("select-unit"===t.type){const{id:e,actions:i}=t.details;this.battle.field.showUnitActions(i)}else if("show-unit-potential-actions"===t.type){const{actions:e}=t.details;this.battle.field.showUnitActions(e)}else if("show-unit-info"===t.type)this.battle.openUnitInfo(t.details);else if("init"===t.type){this.battle.field.clear();const{size:e,mapImageDataUrl:i,buildings:a,units:s,graves:l,round:n,player:d,activeUnitsCount:o}=t.details;this.battle.field.width=e.width,this.battle.field.height=e.height,this.battle.field.terrainLayer.setSrc(i),a.forEach((t=>this.battle.field.addBuilding(t))),s.forEach((t=>this.battle.field.addUnit(t))),l.forEach((t=>this.battle.field.addGrave(t))),this.updateBattle(d,n,o),"ai"===d.type&&this.ai.run(d.id)}else if("start-turn"===t.type){const{player:e,round:i,income:a,activeUnitsCount:s}=t.details;this.updateBattle(e,i,s),await this.battle.openNewTurnPopup({playerName:"Player "+e.id,playerColor:e.color,income:a,round:i,autoClose:1e3}),"ai"===e.type&&this.ai.run(e.id)}else if("active-units-count-change"===t.type){const{activeUnitsCount:e}=t.details;this.battle.activeUnitsCount=e}else if("game-end"===t.type){const{victory:e}=t.details;this.battle.openGameEnd({victory:e});const i=e?"victory.mp3":"game-over.mp3";this.soundService.play({sound:i,roadIndex:0,loop:!0})}else if("player-defeat"===t.type){const{name:e,color:i}=t.details;await this.battle.openNotification({header:`${e} (${i}) has been defeated`,autoClose:2e3})}else"center"===t.type?this.battle.centerToXY(t.details):"open-store"===t.type?this.battle.openUnitStore(t.details):"story"===t.type?await this.battle.openStory(t.details):"conversation"===t.type?(t.details.cell&&this.battle.centerToXY(t.details.cell),await this.battle.openConversation(t.details)):"notification"===t.type?await this.battle.openNotification(t.details):"open-mission"===t.type&&(await this.api.startMission(t.details.missionId),await this.api.init())}updateBattle(t,e,i){const a="ai"===t.type?"bg-bad.mp3":"bg-good.mp3";this.soundService.play({sound:a,roadIndex:0,loop:!0}),this.battle.playerId=t.id,this.battle.money=t.money,this.battle.color=t.color,this.battle.round=e,this.battle.activeUnitsCount=i,this.battle.clicksDisabled="ai"===t.type,this.battle.field.setClicksDisabled("ai"===t.type)}};
